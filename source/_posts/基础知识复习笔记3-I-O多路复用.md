---
title: 基础知识复习笔记3-I/O多路复用
header_image: /intro/post-bg.jpg
abstract: 个人理解
categories: 学习
tags:
  - 笔记
abbrlink: 830442ea
date: 2024-02-15 14:10:19
---

### 前言
之前看图解计算机基础知识的时候，看过几次I/O多路复用的内容，但感觉都没有抓到本质。面试的时候也被问过几次，回答得也不太好。所以重新梳理一下个人理解。

### I/O
I/O就是输入输出，计算机的存储器（内存）和周边设备的数据传输，最主要的就是文件读取/写入。网络传输也是I/O的一部分，Linux中一切皆文件，网络编程用到的socket也是一个文件描述符。

#### 单个进程的文件读取
- 文件管理是由操作系统完成的，所以实际的文件数据读取和传输需要切换到内核态。
- 相较于内存，外存的文件读取是相当慢的。因此CPU不会白白浪费时间等待，而是会阻塞等待I/O的进程，切换去运行其他进程。直到数据传输准备完毕，内核唤醒等待进程，再继续运行。
- 用户态的进程，需要有一个内核态的进程维护其状态。

#### 多个进程的文件读取
- 为每一个进程的I/O流创建一个进程/线程维护其状态。当并发量很大时，系统资源吃不消。

#### I/O多路复用
用一个进程维护多个I/O连接（网络连接）

##### select
用户态维护一个连接表，最大长度固定。进程调用select尝试获取数据时，将连接表复制到内核里，由内核进程顺序遍历检查每个连接是否有数据事件更新，有的话做标记，然后再把更新后的表复制回用户态，用户态再遍历连接表，找到那些有数据事件更新的连接。

所以总共遍历两次，复制两次

##### poll
本质上和select一样，只是固定长度表变成了变长的链表

##### epoll
用户态调用epoll_create，在内核态创建epoll对象。内核用一个红黑树维护所有连接，一个链表维护当前有事件的连接。有连接发生事件时，内核自动将其加入到链表中。当用户调用 epoll_wait() 函数时，内核只返回当前有事件的、链表中的连接对象。

插入新的连接维护对象，查找、更新，因为是红黑树所以都是 log(n)

### 总结
I/O多路复用就是用一个进程维护多个I/O流的连接，因为每个连接都用一个进程或线程去维护开销是很大的。

I/O多路复用有三种模式，select、poll和epoll。select是采取轮询的模式，将所有连接维护在一个线性表里，每次select都将表复制到内核，由内核检查并更新是否有数据事件发生，再将结果复制回用户态，遍历获取事件更新状态。

poll和select类似，只是将线性表改成了链表，增加了最大并发连接数。

epoll则是在内核中用一个红黑树维护所有连接，有连接发生事件时，内核自动将其加入到一个链表中。当用户调用函数想知道哪些连接有数据事件发生时，内核只需要返回链表中的连接对象。